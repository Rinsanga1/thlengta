<section class="section" style="padding-top:56px;">

  <!-- Normal Scan UI (hidden on iOS QR / in-app browser) -->
  <div data-normal-scan>
    <div class="card pad" style="max-width:640px;margin:0 auto;">
      <div class="topbar" style="margin-bottom:14px;">
        <div>
          <div class="h-eyebrow">
            <span class="chip">Employee</span>
            <span class="chip">Check-in</span>
          </div>
          <h2 style="margin:10px 0 0;">Thlengta Scan</h2>
          <div class="small" style="margin-top:6px;">
            Store: <b><%= store.name %></b>
          </div>
        </div>
      </div>

      <% if (error) { %>
        <div class="error"><%= error %></div>
      <% } %>

      <div class="notice" style="margin:12px 0; background:#f8faf9;">
        <div style="font-weight:900;">Before you continue</div>
        <div class="small" style="margin-top:6px;">
          Turn on Location (GPS). We’ll verify you are inside the store boundary.
        </div>
      </div>

      <form class="form" id="scanForm" method="post" action="/e/scan/<%= store.public_id %>">
        <input type="hidden" name="lat" id="lat" value="" />
        <input type="hidden" name="lng" id="lng" value="" />

        <!-- NEW: device token for anti-buddy-punching -->
        <input type="hidden" name="device_token" id="device_token" value="" />
        <!-- NEW: fingerprinting fields -->
        <input type="hidden" name="fp_tz" id="fp_tz" value="" />
        <input type="hidden" name="fp_sw" id="fp_sw" value="" />
        <input type="hidden" name="fp_sh" id="fp_sh" value="" />
        <input type="hidden" name="fp_dpr" id="fp_dpr" value="" />
        <input type="hidden" name="fp_lang" id="fp_lang" value="" />
        <input type="hidden" name="fp_platform" id="fp_platform" value="" />

        <% if (mode === "first") { %>
          <div class="field">
            <label>Email</label>
            <input type="email" name="email" required placeholder="your@email.com" autocomplete="username" />
            <div class="small">First time on this phone only.</div>
          </div>
        <% } %>

        <div class="field">
          <label>PIN</label>
          <input
            id="pinInput"
            type="password"
            name="pin"
            inputmode="numeric"
            autocomplete="one-time-code"
            required
            placeholder="Enter your PIN"
          />
          <div class="small">Ask your manager if you forgot your PIN.</div>
        </div>

        <!-- Consent line -->
        <div class="small" style="margin-top:10px; color:#666; line-height:1.35;">
          By continuing, you agree that Thlengta may collect your location at scan time and basic device information
          (cookies / device verification) for attendance verification and fraud prevention.
        </div>

        <!-- IMPORTANT: not submit -->
        <button class="btn primary full" id="submitBtn" type="button" style="margin-top:10px;">
          <%= mode === "first" ? "Verify and Check In" : "Check In" %>
        </button>

        <div class="card pad" style="background:#fff; margin-top:14px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="badge" style="background:#eaf6f0;">
              <span class="dot"></span> Location Status
            </span>
            <div class="small" id="gpsStatus">JS not loaded yet…</div>
          </div>

          <div class="small" id="gpsDebug" style="margin-top:8px;"></div>
        </div>

        <div class="small" style="margin-top:10px;">
          Tip: If location permission is blocked, open browser settings and allow location for this site.
        </div>
      </form>
    </div>
  </div>

  <!-- iOS QR / in-app browser Gate UI -->
  <div data-ios-qr-gate style="display:none;">
    <div class="card pad" style="max-width:640px;margin:0 auto; text-align:center;">
      <div class="topbar" style="margin-bottom:14px;">
        <div>
          <div class="h-eyebrow" style="justify-content:center;">
            <span class="chip">iPhone</span>
            <span class="chip">QR Scanner</span>
          </div>
          <h2 style="margin:10px 0 0;">Open in Safari</h2>
          <div class="small" style="margin-top:6px;">
            Store: <b><%= store.name %></b>
          </div>
        </div>
      </div>

      <div class="notice" style="margin:12px 0; background:#f8faf9; text-align:left;">
        <div style="font-weight:900;">Why you’re seeing this</div>
        <div class="small" style="margin-top:6px;">
          iPhone QR scanner opens a temporary browser that cannot stay logged in. Attendance works only in Safari.
        </div>
      </div>

      <button type="button" class="btn primary full" data-open-safari>
        Open on Phone Browser
      </button>

      <div class="small" data-ios-hint style="margin-top:12px; text-align:left;">
        Tap the button. If Safari does not open, use Share → <b>Open in Safari</b>.
      </div>
    </div>
  </div>

</section>

<script src="/js/scan.js" defer></script>
<script src="/js/ios-qr-detect.js" defer></script>
