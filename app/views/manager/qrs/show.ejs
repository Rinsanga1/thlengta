<header class="nav">
  <div class="container nav-inner">
    <div class="brand">
      <span>
        <img src="/assets/img/thlengtalogo.png" alt="Thlengta logo" width="80px"/>
      </span>
      <span class="small">
        <img src="/assets/img/thlengtalogotext.png" atl="Thlengta logo type" width="195px"/>
      </span>
      <span class="small">
        <img src="/assets/img/com.png" atl="Thlengta logo type" width="75px" style="margin-left: -10px"/>
      </span>
    </div>
    <nav class="nav-links">
      <a class="btn" href="/manager/dashboard">Back</a>
    </nav>
  </div>
</header>

<section class="section" style="padding-top:46px;">
  <div class="card pad super" style="max-width:980px;margin:0 auto;">
    <div class="topbar" style="margin-bottom:14px;">
      <div>
        <div class="h-eyebrow">
          <span class="chip">Store</span>
          <span class="chip">QR</span>
        </div>
        <h2 style="margin:10px 0 0;">Store QR</h2>
        <div class="small" style="margin-top:6px;">
          Store: <b><%= store.name %></b>
        </div>
      </div>
    </div>

    <!-- QR card -->
    <div class="card pad" style="background:#fff;">
      <h3 style="margin:0 0 10px;">Print this QR</h3>

      <div style="display:flex; justify-content:center;">
        <div style="background:#fff; padding:14px; border-radius:16px; border:2px solid rgba(0,0,0,0.1); box-shadow: 4px 4px 0 rgba(0,0,0,0.12);">
          <img
            id="rawPreview"
            src="/manager/store/<%= store.id %>/qr.png"
            alt="QR"
            width="260"
            height="260"
            style="display:block;"
          />
        </div>
      </div>

      <div class="small" style="margin-top:12px;">
        Print once and keep it near the entrance or counter.
      </div>

      <div class="actions" style="margin-top:12px;">
        <!-- NEW: framed download -->
        <button class="btn primary" id="framedBtn" type="button" style="width:auto;">
          Download QR
        </button>

        <!-- Optional: raw QR -->
        <a class="btn" id="rawBtn"
           href="/manager/store/<%= store.id %>/qr.png"
           download="store-<%= store.id %>-qr.png"
           style="width:auto;">
          Download RAW
        </a>

        <a class="btn" href="/manager/store/<%= store.id %>/employees">Employees</a>
      </div>

      <!-- Hidden canvas for framed QR generation -->
      <canvas id="posterCanvas" style="display:none;"></canvas>

      <!-- Mount data for qrPoster.js -->
      <div
        id="qrPosterMount"
        data-frame-url="/assets/img/qr-frame.png"
        data-raw-template="/manager/store/{ID}/qr.png"
        data-store-id="<%= store.id %>"
        data-qr-scale="0.60"
        data-offset-x="0"
        data-offset-y="0"
      ></div>

      <!-- External JS only -->
      <script src="/client/utils/qrPoster.js" defer></script>
    </div>

    <div style="height:14px;"></div>

    <!-- Location + scan URL -->
    <div class="card pad" style="background:#f8faf9;">
      <h3 style="margin:0 0 10px;">Store Location</h3>

      <div class="small" style="margin:0 0 10px;">
        Coordinates (read-only)
      </div>

      <div class="field">
        <label>Latitude</label>
        <input value="<%= store.lat ?? '' %>" readonly onclick="this.select()" />
      </div>

      <div class="field">
        <label>Longitude</label>
        <input value="<%= store.lng ?? '' %>" readonly onclick="this.select()" />
      </div>

      <div class="field">
        <label>Radius (meters)</label>
        <input value="<%= store.radius_m ?? '' %>" readonly onclick="this.select()" />
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Scan URL (tap to select)</label>
        <input value="<%= scanUrl %>" readonly onclick="this.select()" />
      </div>

      <div class="notice" style="margin-top:12px;">
        <div style="font-weight:900;">Employee flow</div>
        <div class="small" style="margin-top:6px;">
          1) Scan QR<br/>
          2) Enter PIN<br/>
          3) GPS check verifies they are inside the store boundary<br/>
          4) Attendance is recorded
        </div>
      </div>

      <div class="notice" style="margin-top:12px; background:#eaf6f0;">
        <div style="font-weight:900;">Tip</div>
        <div class="small" style="margin-top:6px;">
          If GPS fails at the correct location, ask the admin to increase the store radius slightly.
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <a class="btn" href="/manager/store/<%= store.id %>/logs">View Logs</a>
      </div>
    </div>

  </div>
</section>
