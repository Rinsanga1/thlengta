<section class="section" style="padding-top:46px;">
  <div style="max-width:980px;margin:0 auto 20px;">
    <a class="btn" href="/owner/dashboard" style="width:auto;">‚Üê Back to Dashboard</a>
  </div>
  
  <div class="card pad super" style="max-width:980px;margin:0 auto;">
    <div class="topbar" style="margin-bottom:14px;">
      <div>
        <div class="h-eyebrow">
          <span class="chip">Workplace</span>
          <span class="chip">Settings</span>
        </div>
        <h2 style="margin:10px 0 0;">Edit Workplace</h2>
        <div class="small" style="margin-top:6px;">
          Update your workplace details below.
        </div>
      </div>
    </div>

    <% if (message) { %>
      <div class="notice" style="background:#eaf6f0; margin-bottom:14px;"><%= message %></div>
    <% } %>

    <% if (error) { %>
      <div class="error" style="margin-bottom:14px;"><%= error %></div>
    <% } %>

    <form class="form" method="post" action="/owner/workplaces/<%= workplace.id %>/settings" enctype="multipart/form-data">
      
      <!-- Section 1: Basic Info -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">1. Basic Information</h3>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
          <div class="field">
            <label>Workplace Name *</label>
            <input
              type="text"
              name="name"
              required
              value="<%= workplace.name || '' %>"
            />
          </div>

          <div class="field">
            <label>Address</label>
            <input
              type="text"
              name="address"
              value="<%= workplace.address || '' %>"
              placeholder="Street, City, State"
            />
          </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px;">
          <div class="field">
            <label>Opening Time</label>
            <input
              type="text"
              name="open_time"
              data-smarttime="1"
              value="<%= workplace.open_time || '' %>"
              placeholder="09:00"
            />
          </div>

          <div class="field">
            <label>Closing Time</label>
            <input
              type="text"
              name="close_time"
              data-smarttime="1"
              value="<%= workplace.close_time || '' %>"
              placeholder="18:00"
            />
          </div>
        </div>

        <div class="field" style="margin-top:14px;">
          <label>
            <input type="checkbox" name="grace_enabled" value="1" <%= workplace.grace_enabled ? 'checked' : '' %> />
            Enable grace period (<%= workplace.grace_minutes || 10 %> minutes)
          </label>
        </div>

        <div class="card pad" style="background:#f8faf9; margin-top:20px;">
          <h3 style="margin:0 0 15px;">Logo</h3>
          
          <% if (workplace.logo_path) { %>
            <img src="<%= workplace.logo_path %>" style="max-width:150px; margin-bottom:14px; border-radius:8px;" />
          <% } %>
          
          <div class="field">
            <label>Update Logo (optional)</label>
            <input type="file" name="logo" accept="image/png,image/jpeg,image/webp" />
            <div class="small">Leave empty to keep current logo</div>
          </div>
        </div>
      </div>

      <!-- Section 2: Location -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">2. Location</h3>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
          <div class="field">
            <label>Latitude</label>
            <input type="number" step="any" name="lat" value="<%= workplace.lat || '' %>" />
          </div>

          <div class="field">
            <label>Longitude</label>
            <input type="number" step="any" name="lng" value="<%= workplace.lng || '' %>" />
          </div>
        </div>

        <div class="actions" style="margin-top:14px;">
          <button class="btn" type="button" id="btnUseLoc" style="width:auto;">Use my current location</button>
        </div>

        <% if (workplace.lat && workplace.lng) { %>
        <div class="card pad" style="background:#f8faf9; margin-top:14px;">
          <h4 style="margin:0 0 10px;">Current Location Map</h4>
          <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden;">
            <iframe
              width="100%"
              height="200"
              style="border:0;"
              loading="lazy"
              src="https://www.google.com/maps?q=<%= workplace.lat %>,<%= workplace.lng %>&z=16&output=embed"
            ></iframe>
          </div>
        </div>
        <% } %>
      </div>

      <!-- Section 3: Radius -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">3. Check-in Radius</h3>
        
        <div class="field">
          <label>Radius (meters)</label>
          <input
            type="number"
            name="radius_m"
            min="10"
            max="1000"
            value="<%= workplace.radius_m || 70 %>"
          />
          <div class="small">Allowed: 10 to 1000 meters</div>
        </div>
      </div>

      <!-- Save Section -->
      <div class="actions" style="margin-top:24px; margin-bottom:24px;">
        <button class="btn primary" type="submit" style="width:auto; font-size:16px; padding:12px 24px;">Save Changes</button>
        <a class="btn" href="/owner/workplaces/<%= workplace.id %>?tab=qr" style="width:auto;">View QR</a>
      </div>

      <!-- Mobile stacking -->
      <style>
        @media (max-width: 820px){
          .card.pad.super > form > div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
          }
        }
      </style>
    </form>

    <!-- Danger Zone -->
    <div class="card pad" style="background:#fff3f3; margin-top:20px;">
      <h3 style="margin:0 0 15px; color:#d32f2f;">Danger Zone</h3>
      <p class="small">Deleting this workplace will remove all employees, logs, and data associated with it. This cannot be undone.</p>
      <form method="post" action="/owner/workplaces/<%= workplace.id %>/delete" onsubmit="return confirm('Are you sure? This will delete ALL data including employees and attendance logs. This cannot be undone.');">
        <button type="submit" class="btn" style="width:auto; background:#d32f2f; color:white;">Delete Workplace</button>
      </form>
    </div>
  </div>
</section>

<script src="/client/utils/smart_time_12h.js" defer></script>
<script src="/client/utils/workplace_location.js" defer></script>
