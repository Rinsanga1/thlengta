<section class="section" style="padding-top:46px;">
  <div class="card pad super" style="max-width:980px;margin:0 auto;">
    <div class="topbar" style="margin-bottom:14px;">
      <div>
        <div class="h-eyebrow">
          <span class="chip">Workplace</span>
          <span class="chip">Setup</span>
        </div>
        <h2 style="margin:10px 0 0;">Create New Workplace</h2>
        <div class="small" style="margin-top:6px;">
          Set up your workplace in one go. Fill in all the details below.
        </div>
      </div>
    </div>

    <% if (error) { %>
      <div class="error"><%= error %></div>
    <% } %>

    <form class="form" method="post" action="/owner/workplaces" enctype="multipart/form-data">
      
      <!-- Section 1: Define Your Workplace -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">1. Define Your Workplace</h3>
        
        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:14px;">
          <!-- Left: Basic info -->
          <div>
            <div class="field">
              <label>Workplace Name *</label>
              <input
                type="text"
                name="name"
                required
                placeholder="Example: SUNSET CAFE or ACME Corp"
                value="<%= formData.name || '' %>"
              />
            </div>

            <div class="field">
              <label>Workplace Logo (optional)</label>
              <div style="display:flex; flex-direction:column; gap:6px;">
                <input type="file" name="logo" accept="image/png,image/jpeg,image/webp" />
                <div class="small">PNG/JPG/WebP supported.</div>
              </div>
            </div>

            <div class="field">
              <label>Address (optional)</label>
              <input
                type="text"
                name="address"
                placeholder="Street, City, State"
                value="<%= formData.address || '' %>"
              />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
              <div class="field">
                <label>Opening Time *</label>
                <input
                  type="text"
                  name="opening_time"
                  data-smarttime="1"
                  required
                  placeholder="e.g. 930, 1030am, 7pm"
                  value="<%= formData.opening_time || '' %>"
                />
                <div class="small">Tip: type 1030am, 930, 7pm</div>
              </div>

              <div class="field">
                <label>Closing Time *</label>
                <input
                  type="text"
                  name="closing_time"
                  data-smarttime="1"
                  required
                  placeholder="e.g. 6pm"
                  value="<%= formData.closing_time || '' %>"
                />
              </div>
            </div>
          </div>

          <!-- Right: Tips -->
          <div class="card pad" style="background:#f8faf9;">
            <h3 style="margin:0 0 10px;">Quick tips</h3>

            <div class="notice" style="margin-bottom:12px;">
              <div style="font-weight:900;">Why opening and closing time?</div>
              <div class="small" style="margin-top:6px;">
                This helps logs show on-time vs late, and later we can enforce sign-out before leaving.
              </div>
            </div>

            <div class="notice" style="background:#eaf6f0;">
              <div style="font-weight:900;">Works for any business</div>
              <div class="small" style="margin-top:6px;">
                You can use workplace for stores, offices, schools, teams, and field sites.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: Workplace Location -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">2. Where is your workplace located?</h3>
        
        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:14px; align-items:start;">
          <!-- Left: location inputs -->
          <div>
            <div class="small" style="margin:0 0 12px;">
              If you are at the workplace now, use your current location. Otherwise, add coordinates manually.
            </div>

            <div class="actions" style="margin-top:0; gap:10px; display:flex; flex-wrap:wrap;">
              <button class="btn" type="button" id="btnUseLoc" style="width:auto;">Use my current location</button>
              <a class="btn" href="https://www.google.com/maps" target="_blank" rel="noreferrer" style="width:auto;">Open Google Maps</a>
            </div>

            <div id="locStatus" class="notice" style="margin-top:12px;background:#fff7df;">
              <div style="font-weight:900;">Not set yet</div>
              <div class="small" style="margin-top:6px;">
                Click "Use my current location" or enter coordinates manually below.
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; margin-top:14px;">
              <div class="field">
                <label>Latitude *</label>
                <input type="number" step="any" name="lat" id="lat" placeholder="23.7271" required value="<%= formData.lat || '' %>" />
              </div>

              <div class="field">
                <label>Longitude *</label>
                <input type="number" step="any" name="lng" id="lng" placeholder="92.7176" required value="<%= formData.lng || '' %>" />
              </div>

              <div class="field">
                <label>Accuracy (meters)</label>
                <input type="number" step="any" name="accuracy_m" id="accuracy_m" placeholder="Example: 15" value="<%= formData.accuracy_m || '' %>" />
                <div class="small">Optional, from GPS</div>
              </div>
            </div>
          </div>

          <!-- Right: map preview -->
          <div class="card pad" style="background:#f8faf9;">
            <h3 style="margin:0 0 10px;">Map preview</h3>
            <div class="small" style="margin:0 0 10px;">
              Updates when you set location.
            </div>

            <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden;">
              <iframe
                id="mapFrame"
                title="Map preview"
                width="100%"
                height="260"
                style="border:0;display:block;"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://www.google.com/maps?q=23.000000,92.000000&z=16&output=embed"
              ></iframe>
            </div>

            <div class="small" style="margin-top:10px;">
              Tip: GPS indoors can be slightly off. You will set radius next.
            </div>
          </div>
        </div>
      </div>

      <!-- Section 3: Set Radius -->
      <div class="card pad" style="background:#fff; margin-bottom:20px;">
        <h3 style="margin:0 0 15px; color:var(--primary);">3. Set Check-in Radius</h3>
        
        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:14px; align-items:start;">
          <!-- Left: Radius -->
          <div>
            <div class="field">
              <label>Radius (meters) *</label>
              <input
                type="number"
                name="radius_m"
                min="10"
                max="1000"
                required
                value="<%= formData.radius_m || 70 %>"
              />
              <div class="small">Allowed: 10 to 1000 meters. Default: 70m</div>
            </div>

            <div class="notice" style="margin-top:12px; background:#fff7df;">
              <div style="font-weight:900;">Quick check</div>
              <div class="small" style="margin-top:6px;">
                If your staff will be indoors (GPS drift), don't set it too tight.
              </div>
            </div>
          </div>

          <!-- Right: Tips -->
          <div class="card pad" style="background:#f8faf9;">
            <h3 style="margin:0 0 10px;">Recommendations</h3>

            <div class="notice" style="background:#eaf6f0;">
              <div style="font-weight:900;">Start with 50-80m</div>
              <div class="small" style="margin-top:6px;">
                If check-in fails often, increase slightly in settings later.
              </div>
            </div>

            <div class="notice" style="margin-top:12px;">
              <div style="font-weight:900;">Real world</div>
              <div class="small" style="margin-top:6px;">
                GPS can drift indoors. A slightly bigger radius is normal.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Section -->
      <div class="actions" style="margin-top:24px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn primary" type="submit" style="width:auto; font-size:16px; padding:12px 24px;">Create Workplace</button>
        <a class="btn" href="/owner/dashboard" style="width:auto;">Cancel</a>
      </div>

      <!-- Mobile stacking -->
      <style>
        @media (max-width: 820px){
          .card.pad.super > form > div[style*="grid-template-columns"],
          .card.pad.super form div[style*="grid-template-columns: 1fr 1fr"],
          .card.pad.super form div[style*="grid-template-columns: 1fr 1fr 1fr"] {
            grid-template-columns: 1fr !important;
          }
          #mapFrame { height: 280px; }
        }
      </style>
    </form>
  </div>
</section>

<script src="/client/utils/smart_time_12h.js" defer></script>
<script src="/client/utils/workplace_location.js" defer></script>
